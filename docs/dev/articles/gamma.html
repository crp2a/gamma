<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Manual • gamma</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Manual">
<meta property="og:description" content="">
<meta property="og:image" content="http://gamma.archaeo.science/logo.png">
<meta name="twitter:card" content="summary">
<meta name="robots" content="noindex">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">gamma</a>
        <span class="version label label-danger" data-toggle="tooltip" data-placement="bottom" title="In-development version">0.1.0.9004</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/gamma.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/cerege_1.html">CEREGE Calibration Curve #1</a>
    </li>
    <li>
      <a href="../articles/crp2a_1.html">CRP2A Calibration Curve #1</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/crp2a/gamma">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Manual</h1>
                        <h4 class="author">N. Frerebeau</h4>
                        <h4 class="author">B. Lebrun</h4>
                        <h4 class="author">G. Guérin</h4>
                        <h4 class="author">C. Lahaye</h4>
            
            <h4 class="date">2019-05-22</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/crp2a/gamma/blob/master/vignettes/gamma.Rmd"><code>vignettes/gamma.Rmd</code></a></small>
      <div class="hidden name"><code>gamma.Rmd</code></div>

    </div>

    
    
<div id="overview" class="section level1">
<h1 class="hasAnchor">
<a href="#overview" class="anchor"></a>Overview</h1>
<p><code>gamma</code> is intended to process in-situ gamma-ray spectrometry measurements for luminescence dating. This package allows to import, inspect and (automatically) correct the energy scale of the spectrum. It provides methods for estimating the gamma dose rate by the use of a calibration curve. This package only supports Canberra CNF and TKA files.</p>
<p>Typical workflow:</p>
<ol style="list-style-type: decimal">
<li>Import spectrum data with <code><a href="../reference/read.html">read()</a></code>,</li>
<li>Inspect spectrum with <code><a href="../reference/plot.html">plot()</a></code>,</li>
<li>Calibrate the energy scale with <code><a href="../reference/calibrate.html">calibrate()</a></code>,</li>
<li>Estimate the gamma dose rate with <code><a href="../reference/predict.html">predict()</a></code>.</li>
</ol>
<p>The estimation of the gamma dose rate requires a calibration curve. This package contains several built-in curves, but as these are instrument-specific you may need to build your own (see <code><a href="https://www.rdocumentation.org/packages/utils/topics/help">help(fit)</a></code>). These built-in curves are in use in several labs and can be used to reproduce published results. Check out the following vignettes for an overview of the fitting process.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="co"># IRAMAT-CRP2A LaBr (BDX1)</span></a>
<a class="sourceLine" id="cb1-2" data-line-number="2">utils<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/vignette">vignette</a></span>(<span class="st">"CRP2A#1"</span>, <span class="dt">package =</span> <span class="st">"gamma"</span>)</a>
<a class="sourceLine" id="cb1-3" data-line-number="3"></a>
<a class="sourceLine" id="cb1-4" data-line-number="4"><span class="co"># CEREGE NaI (AIX1)</span></a>
<a class="sourceLine" id="cb1-5" data-line-number="5">utils<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/vignette">vignette</a></span>(<span class="st">"CEREGE#1"</span>, <span class="dt">package =</span> <span class="st">"gamma"</span>)</a></code></pre></div>
<p>Note that <code>gamma</code> uses the <em>International System of Units</em>: energy values are assumed to be in keV and dose rates in µGy/y.</p>
</div>
<div id="import-file" class="section level1">
<h1 class="hasAnchor">
<a href="#import-file" class="anchor"></a>Import file</h1>
<p>Both Canberra CNF and TKA files can be imported. Several channels can be skipped during import to retain only part of the spectrum.</p>
<p>If <code>skip</code> is <code>TRUE</code>, an attempt is made to define the number of channels to skip at the beginning of the spectrum. This skips all channels before the highest count maximum. This is intended to deal with the artefact produced by the rapid growth of random background noise towards low energies.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="co"># Automatically skip the first chanels</span></a>
<a class="sourceLine" id="cb2-2" data-line-number="2"><span class="co"># Import a CNF file</span></a>
<a class="sourceLine" id="cb2-3" data-line-number="3">cnf_test &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/system.file">system.file</a></span>(<span class="st">"extdata/test_CNF.cnf"</span>, <span class="dt">package =</span> <span class="st">"gamma"</span>)</a>
<a class="sourceLine" id="cb2-4" data-line-number="4">(spc_cnf &lt;-<span class="st"> </span><span class="kw"><a href="../reference/read.html">read</a></span>(cnf_test, <span class="dt">skip =</span> <span class="ot">TRUE</span>))</a>
<a class="sourceLine" id="cb2-5" data-line-number="5"><span class="co">#&gt; Gamma spectrum:</span></a>
<a class="sourceLine" id="cb2-6" data-line-number="6"><span class="co">#&gt;   Reference: test_CNF</span></a>
<a class="sourceLine" id="cb2-7" data-line-number="7"><span class="co">#&gt;   Instrument: InSpector 1000</span></a>
<a class="sourceLine" id="cb2-8" data-line-number="8"><span class="co">#&gt;   Date: 2019-02-07 11:48:18</span></a>
<a class="sourceLine" id="cb2-9" data-line-number="9"><span class="co">#&gt;   Number of chanels: 989</span></a>
<a class="sourceLine" id="cb2-10" data-line-number="10"><span class="co">#&gt;   Energy range (keV): 97.94 - 3124.91</span></a>
<a class="sourceLine" id="cb2-11" data-line-number="11"><span class="co">#&gt;   Dose rate: not known</span></a>
<a class="sourceLine" id="cb2-12" data-line-number="12"></a>
<a class="sourceLine" id="cb2-13" data-line-number="13"><span class="co"># Import a TKA file</span></a>
<a class="sourceLine" id="cb2-14" data-line-number="14">tka_test &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/system.file">system.file</a></span>(<span class="st">"extdata/test_TKA.tka"</span>, <span class="dt">package =</span> <span class="st">"gamma"</span>)</a>
<a class="sourceLine" id="cb2-15" data-line-number="15">(spc_tka &lt;-<span class="st"> </span><span class="kw"><a href="../reference/read.html">read</a></span>(tka_test, <span class="dt">skip =</span> <span class="ot">TRUE</span>))</a>
<a class="sourceLine" id="cb2-16" data-line-number="16"><span class="co">#&gt; Gamma spectrum:</span></a>
<a class="sourceLine" id="cb2-17" data-line-number="17"><span class="co">#&gt;   Reference: test_TKA</span></a>
<a class="sourceLine" id="cb2-18" data-line-number="18"><span class="co">#&gt;   Instrument: unknown</span></a>
<a class="sourceLine" id="cb2-19" data-line-number="19"><span class="co">#&gt;   Date: 2019-05-22 16:10:37</span></a>
<a class="sourceLine" id="cb2-20" data-line-number="20"><span class="co">#&gt;   Number of chanels: 989</span></a>
<a class="sourceLine" id="cb2-21" data-line-number="21"><span class="co">#&gt;   Energy range (keV): not calibrated</span></a>
<a class="sourceLine" id="cb2-22" data-line-number="22"><span class="co">#&gt;   Dose rate: not known</span></a>
<a class="sourceLine" id="cb2-23" data-line-number="23"></a>
<a class="sourceLine" id="cb2-24" data-line-number="24"><span class="co"># Import all files in a given directory</span></a>
<a class="sourceLine" id="cb2-25" data-line-number="25">files_test &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/system.file">system.file</a></span>(<span class="st">"extdata"</span>, <span class="dt">package =</span> <span class="st">"gamma"</span>)</a>
<a class="sourceLine" id="cb2-26" data-line-number="26">(spc &lt;-<span class="st"> </span><span class="kw"><a href="../reference/read.html">read</a></span>(files_test, <span class="dt">skip =</span> <span class="ot">TRUE</span>))</a>
<a class="sourceLine" id="cb2-27" data-line-number="27"><span class="co">#&gt; A collection of 2 gamma spectra: test_CNF, test_TKA</span></a></code></pre></div>
</div>
<div id="inspect-spectrum" class="section level1">
<h1 class="hasAnchor">
<a href="#inspect-spectrum" class="anchor"></a>Inspect spectrum</h1>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="co"># Plot TKA spectrum</span></a>
<a class="sourceLine" id="cb3-2" data-line-number="2"><span class="kw"><a href="../reference/plot.html">plot</a></span>(spc_cnf) <span class="op">+</span></a>
<a class="sourceLine" id="cb3-3" data-line-number="3"><span class="st">  </span>ggplot2<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggplot2/topics/ggtheme">theme_bw</a></span>()</a></code></pre></div>
<p><img src="gamma_files/figure-html/inspect-1.png" width="672" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="co"># Plot spectra</span></a>
<a class="sourceLine" id="cb4-2" data-line-number="2"><span class="kw"><a href="../reference/plot.html">plot</a></span>(spc, <span class="dt">facet =</span> <span class="ot">TRUE</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb4-3" data-line-number="3"><span class="st">  </span>ggplot2<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggplot2/topics/ggtheme">theme_bw</a></span>()</a></code></pre></div>
<p><img src="gamma_files/figure-html/inspect-2.png" width="672" style="display: block; margin: auto;"></p>
</div>
<div id="calibrate-the-energy-scale" class="section level1">
<h1 class="hasAnchor">
<a href="#calibrate-the-energy-scale" class="anchor"></a>Calibrate the energy scale</h1>
<p>The energy calibration of a spectrum is the most tricky part. To do this, you must specify the position of at least two observed peaks and the corresponding energy value (in keV).</p>
<p>The package allows you to provide the channel-energy pairs you want to use. However, the spectrum can be noisy so it is difficult to properly determine the peak channel. In this case, a better approach may be to fit each peak with a Gaussian curve and then use the parameters estimated in this way.</p>
<p>Regardless of the approach you choose, it is strongly recommended to check the result before proceeding.</p>
<div id="peak-parameters-estimation" class="section level2">
<h2 class="hasAnchor">
<a href="#peak-parameters-estimation" class="anchor"></a>Peak parameters estimation</h2>
<p>The automatic estimation of peak parameters is performed in two steps that can influence the final result. First, the baseline of the spectrum is estimated and removed. Then, a non-linear model is fitted for each peak. The model parameters can finally be used for the spectrum energy scale calibration.</p>
<p>These two steps (baseline and peak fitting) are performed in one go. The following sections will help you to fine-tune the individual parameters.</p>
<div id="estimate-and-remove-baseline" class="section level3">
<h3 class="hasAnchor">
<a href="#estimate-and-remove-baseline" class="anchor"></a>Estimate and remove baseline</h3>
<p>The baseline estimation is performed using the SNIP algorithm <span class="citation">(Ryan et al. 1988; Morháč et al. 1997; Morháč and Matoušek 2008)</span>. You can apply the LLS operator to your data, use a decreasing clipping window or change the number of iterations (see references).</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="co"># Estimate the baseline of a single file</span></a>
<a class="sourceLine" id="cb5-2" data-line-number="2"><span class="co"># Default parameters:</span></a>
<a class="sourceLine" id="cb5-3" data-line-number="3"><span class="co"># * The LLS operator is not used,</span></a>
<a class="sourceLine" id="cb5-4" data-line-number="4"><span class="co"># * An increasing clipping window is used,</span></a>
<a class="sourceLine" id="cb5-5" data-line-number="5"><span class="co"># * 100 iterations are performed.</span></a>
<a class="sourceLine" id="cb5-6" data-line-number="6">baseline &lt;-<span class="st"> </span><span class="kw"><a href="../reference/processBaseline.html">estimateBaseline</a></span>(spc_tka)</a>
<a class="sourceLine" id="cb5-7" data-line-number="7"></a>
<a class="sourceLine" id="cb5-8" data-line-number="8"><span class="co"># Plot spectrum + baseline</span></a>
<a class="sourceLine" id="cb5-9" data-line-number="9"><span class="kw"><a href="../reference/plot.html">plot</a></span>(spc_tka, baseline) <span class="op">+</span></a>
<a class="sourceLine" id="cb5-10" data-line-number="10"><span class="st">  </span>ggplot2<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggplot2/topics/ggtheme">theme_bw</a></span>()</a></code></pre></div>
<p><img src="gamma_files/figure-html/baseline-estimate-1.png" width="672" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1"><span class="co"># Substract the previously estimated baseline</span></a>
<a class="sourceLine" id="cb6-2" data-line-number="2">spc_clean1 &lt;-<span class="st"> </span>spc_tka <span class="op">-</span><span class="st"> </span>baseline</a>
<a class="sourceLine" id="cb6-3" data-line-number="3"><span class="co"># Or, remove the baseline in one go</span></a>
<a class="sourceLine" id="cb6-4" data-line-number="4">spc_clean2 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/processBaseline.html">removeBaseline</a></span>(spc_tka)</a>
<a class="sourceLine" id="cb6-5" data-line-number="5"></a>
<a class="sourceLine" id="cb6-6" data-line-number="6"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/identical">identical</a></span>(spc_clean1, spc_clean2)</a>
<a class="sourceLine" id="cb6-7" data-line-number="7"><span class="co">#&gt; [1] TRUE</span></a>
<a class="sourceLine" id="cb6-8" data-line-number="8"></a>
<a class="sourceLine" id="cb6-9" data-line-number="9"><span class="co"># Plot the corrected spectrum</span></a>
<a class="sourceLine" id="cb6-10" data-line-number="10"><span class="kw"><a href="../reference/plot.html">plot</a></span>(spc_clean1) <span class="op">+</span></a>
<a class="sourceLine" id="cb6-11" data-line-number="11"><span class="st">  </span>ggplot2<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggplot2/topics/ggtheme">theme_bw</a></span>()</a></code></pre></div>
<p><img src="gamma_files/figure-html/baseline-remove-1.png" width="672" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" data-line-number="1"><span class="co"># You can change the default parameters (see help for details)</span></a>
<a class="sourceLine" id="cb7-2" data-line-number="2"><span class="co"># help(SNIP)</span></a>
<a class="sourceLine" id="cb7-3" data-line-number="3">spc_clean3 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/processBaseline.html">removeBaseline</a></span>(spc_tka, <span class="dt">LLS =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb7-4" data-line-number="4"></a>
<a class="sourceLine" id="cb7-5" data-line-number="5"><span class="co"># The default settings don't seem too bad</span></a>
<a class="sourceLine" id="cb7-6" data-line-number="6"><span class="kw"><a href="../reference/plot.html">plot</a></span>(spc_clean1, spc_clean3) <span class="op">+</span></a>
<a class="sourceLine" id="cb7-7" data-line-number="7"><span class="st">  </span>ggplot2<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggplot2/topics/ggtheme">theme_bw</a></span>()</a></code></pre></div>
<p><img src="gamma_files/figure-html/baseline-plot-1.png" width="672" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" data-line-number="1"><span class="co"># You can remove the baseline of multiple spectra in one go</span></a>
<a class="sourceLine" id="cb8-2" data-line-number="2"><span class="co"># Note that the same parameters will be used for all spectra</span></a>
<a class="sourceLine" id="cb8-3" data-line-number="3">spc_clean &lt;-<span class="st"> </span><span class="kw"><a href="../reference/processBaseline.html">removeBaseline</a></span>(spc)</a></code></pre></div>
</div>
<div id="automatic-peak-detection" class="section level3">
<h3 class="hasAnchor">
<a href="#automatic-peak-detection" class="anchor"></a>Automatic peak detection</h3>
<p>Once you have fixed the parameters for the baseline estimation, you can try to automatically find peaks in the spectrum. A local maximum has to be the highest one in the given window and has to be higher than <span class="math inline">\(k\)</span> times the noise to be recognized as peak.</p>
<p>Again, peak finding is performed on the baseline corrected spectrum, so you may want to pass extra arguments for the baseline estimation.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" data-line-number="1"><span class="co"># Detect peaks in a single file</span></a>
<a class="sourceLine" id="cb9-2" data-line-number="2">peak_index &lt;-<span class="st"> </span><span class="kw"><a href="../reference/peaks.html">findPeaks</a></span>(spc_tka)</a>
<a class="sourceLine" id="cb9-3" data-line-number="3"></a>
<a class="sourceLine" id="cb9-4" data-line-number="4"><span class="co"># Plot spectrum</span></a>
<a class="sourceLine" id="cb9-5" data-line-number="5"><span class="kw"><a href="../reference/plot.html">plot</a></span>(peak_index) <span class="op">+</span></a>
<a class="sourceLine" id="cb9-6" data-line-number="6"><span class="st">  </span>ggplot2<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggplot2/topics/ggtheme">theme_bw</a></span>()</a></code></pre></div>
<p><img src="gamma_files/figure-html/peak-detection-1.png" width="672" style="display: block; margin: auto;"></p>
<table class="table">
<caption>Automatic peak detection</caption>
<thead><tr class="header">
<th></th>
<th align="right">Chanel</th>
<th align="right">Energy [keV]</th>
<th align="right">Count</th>
<th align="right">Count rate [1/s]</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>peak #1</td>
<td align="right">86</td>
<td align="right">NA</td>
<td align="right">2376</td>
<td align="right">0.702</td>
</tr>
<tr class="even">
<td>peak #2</td>
<td align="right">210</td>
<td align="right">NA</td>
<td align="right">840</td>
<td align="right">0.248</td>
</tr>
<tr class="odd">
<td>peak #3</td>
<td align="right">316</td>
<td align="right">NA</td>
<td align="right">297</td>
<td align="right">0.088</td>
</tr>
<tr class="even">
<td>peak #4</td>
<td align="right">496</td>
<td align="right">NA</td>
<td align="right">910</td>
<td align="right">0.269</td>
</tr>
<tr class="odd">
<td>peak #5</td>
<td align="right">876</td>
<td align="right">NA</td>
<td align="right">110</td>
<td align="right">0.032</td>
</tr>
</tbody>
</table>
<p>The result of this automatic detection can be used as starting positions for peak fitting.</p>
</div>
<div id="peak-fitting" class="section level3">
<h3 class="hasAnchor">
<a href="#peak-fitting" class="anchor"></a>Peak fitting</h3>
<p>If you know the approximate position of some peaks, you can refine it by fitting each peak with a Gaussian. The parameters of these non-linear models are determined using the <em>port</em> algorithm (see <code><a href="https://www.rdocumentation.org/packages/utils/topics/help">help(nls)</a></code> from the <code>{stats}</code> package).</p>
<p>You only need to provide the starting peak positions (chanel). If problems arise, it may be useful to constrain the parameters (see <code><a href="https://www.rdocumentation.org/packages/utils/topics/help">help(fit)</a></code>) or improve the baseline estimate (peak fitting is performed on the baseline corrected spectrum).</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" data-line-number="1"><span class="co"># Fit peaks at a given chanel</span></a>
<a class="sourceLine" id="cb10-2" data-line-number="2">peak_fit &lt;-<span class="st"> </span><span class="kw"><a href="../reference/peaks.html">fitPeaks</a></span>(spc_tka, <span class="dt">peaks =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">86</span>, <span class="dv">496</span>, <span class="dv">876</span>))</a>
<a class="sourceLine" id="cb10-3" data-line-number="3"></a>
<a class="sourceLine" id="cb10-4" data-line-number="4"><span class="co">## Plot results</span></a>
<a class="sourceLine" id="cb10-5" data-line-number="5"><span class="kw"><a href="../reference/plot.html">plot</a></span>(peak_fit) <span class="op">+</span></a>
<a class="sourceLine" id="cb10-6" data-line-number="6"><span class="st">  </span>ggplot2<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggplot2/topics/labs">labs</a></span>(<span class="dt">title =</span> <span class="st">"Fitted peaks from fixed starting positions"</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb10-7" data-line-number="7"><span class="st">  </span>ggplot2<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggplot2/topics/ggtheme">theme_bw</a></span>()</a></code></pre></div>
<p><img src="gamma_files/figure-html/peak-fit-manual-1.png" width="672" style="display: block; margin: auto;"></p>
<table class="table">
<caption>Peak positions</caption>
<thead><tr class="header">
<th></th>
<th align="right">Mean (chanel)</th>
<th align="right">Std. dev. (chanel)</th>
<th align="right">Height (count)</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>peak #1</td>
<td align="right">85.806</td>
<td align="right">2.686</td>
<td align="right">2447.413</td>
</tr>
<tr class="even">
<td>peak #2</td>
<td align="right">494.862</td>
<td align="right">9.744</td>
<td align="right">877.721</td>
</tr>
<tr class="odd">
<td>peak #3</td>
<td align="right">877.186</td>
<td align="right">14.328</td>
<td align="right">98.544</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="energy-scale-calibration" class="section level2">
<h2 class="hasAnchor">
<a href="#energy-scale-calibration" class="anchor"></a>Energy scale calibration</h2>
<p>If you know the correspondence between several channels and the energy scale, you can use these pairs of values to calibrate the spectrum. A second order polynomial model is fitted on these energy <em>vs</em> chanel values, then the chanel values are used to predict the new energy scale.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" data-line-number="1"><span class="co"># Create a list of chanel-enegy pairs</span></a>
<a class="sourceLine" id="cb11-2" data-line-number="2"><span class="co"># Names are optional, but values must always be set in this order</span></a>
<a class="sourceLine" id="cb11-3" data-line-number="3"><span class="co"># (channel then energy)</span></a>
<a class="sourceLine" id="cb11-4" data-line-number="4">calib_lines &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(</a>
<a class="sourceLine" id="cb11-5" data-line-number="5">  <span class="dt">Pb212 =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dt">chanel =</span> <span class="dv">84</span>, <span class="dt">energy =</span> <span class="dv">238</span>),</a>
<a class="sourceLine" id="cb11-6" data-line-number="6">  <span class="dt">K40 =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dt">chanel =</span> <span class="dv">492</span>, <span class="dt">energy =</span> <span class="dv">1461</span>),</a>
<a class="sourceLine" id="cb11-7" data-line-number="7">  <span class="dt">Tl208 =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dt">chanel =</span> <span class="dv">865</span>, <span class="dt">energy =</span> <span class="dv">2615</span>)</a>
<a class="sourceLine" id="cb11-8" data-line-number="8">)</a>
<a class="sourceLine" id="cb11-9" data-line-number="9"></a>
<a class="sourceLine" id="cb11-10" data-line-number="10"><span class="co"># Calibrate the spectrum using these fixed lines</span></a>
<a class="sourceLine" id="cb11-11" data-line-number="11">tka_scaled1 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/calibrate.html">calibrate</a></span>(spc_tka, <span class="dt">lines =</span> calib_lines)</a></code></pre></div>
<p>Alternatively, you can use the results of the peak fitting and pass the expected energy values.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" data-line-number="1"><span class="co"># Calibrate the spectrum using the peak models</span></a>
<a class="sourceLine" id="cb12-2" data-line-number="2"><span class="co"># Lines should be in keV</span></a>
<a class="sourceLine" id="cb12-3" data-line-number="3">tka_scaled2 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/calibrate.html">calibrate</a></span>(peak_fit, <span class="dt">lines =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">238</span>, <span class="dv">1461</span>, <span class="dv">2615</span>))</a>
<a class="sourceLine" id="cb12-4" data-line-number="4"></a>
<a class="sourceLine" id="cb12-5" data-line-number="5"><span class="co"># Plot the spectrum (note the top scale)</span></a>
<a class="sourceLine" id="cb12-6" data-line-number="6"><span class="kw"><a href="../reference/plot.html">plot</a></span>(tka_scaled2) <span class="op">+</span></a>
<a class="sourceLine" id="cb12-7" data-line-number="7"><span class="st">  </span>ggplot2<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggplot2/topics/labs">labs</a></span>(<span class="dt">title =</span> <span class="st">"Calibrated spectra"</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb12-8" data-line-number="8"><span class="st">  </span>ggplot2<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggplot2/topics/ggtheme">theme_bw</a></span>()</a></code></pre></div>
<p><img src="gamma_files/figure-html/calibrate-fit-1.png" width="672" style="display: block; margin: auto;"></p>
</div>
</div>
<div id="estimate-the-gamma-dose-rate" class="section level1">
<h1 class="hasAnchor">
<a href="#estimate-the-gamma-dose-rate" class="anchor"></a>Estimate the gamma dose rate</h1>
<p>To estimate the gamma dose rate, you can either use one of the calibration curves distributed with this package or build your own.</p>
<p>The construction of a calibration curve requires a set of reference spectra for which the gamma dose rate is known and a background noise measurement. First, each reference spectrum is integrated over a given interval, then normalized to active time and corrected for background noise. The dose rate is finally modelled by the integrated signal value used as a linear predictor.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" data-line-number="1"><span class="co"># Import the reference spectra</span></a>
<a class="sourceLine" id="cb13-2" data-line-number="2">calib_dir &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/system.file">system.file</a></span>(<span class="st">"extdata/crp2a/calibration"</span>, <span class="dt">package =</span> <span class="st">"gamma"</span>)</a>
<a class="sourceLine" id="cb13-3" data-line-number="3">calib_spc &lt;-<span class="st"> </span><span class="kw"><a href="../reference/read.html">read</a></span>(calib_dir, <span class="dt">skip =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb13-4" data-line-number="4"></a>
<a class="sourceLine" id="cb13-5" data-line-number="5"><span class="co"># Import the spectra for background noise measurement</span></a>
<a class="sourceLine" id="cb13-6" data-line-number="6">noise_dir &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/system.file">system.file</a></span>(<span class="st">"extdata/crp2a/background"</span>, <span class="dt">package =</span> <span class="st">"gamma"</span>)</a>
<a class="sourceLine" id="cb13-7" data-line-number="7">noise_spc &lt;-<span class="st"> </span><span class="kw"><a href="../reference/read.html">read</a></span>(noise_dir, <span class="dt">skip =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb13-8" data-line-number="8"></a>
<a class="sourceLine" id="cb13-9" data-line-number="9"><span class="co"># Set the known dose rates</span></a>
<a class="sourceLine" id="cb13-10" data-line-number="10"><span class="kw">setDoseRate</span>(calib_spc) &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(</a>
<a class="sourceLine" id="cb13-11" data-line-number="11">  <span class="dt">BRIQUE =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">1986</span>, <span class="dv">36</span>),</a>
<a class="sourceLine" id="cb13-12" data-line-number="12">  <span class="dt">C341 =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">850</span>, <span class="dv">21</span>),</a>
<a class="sourceLine" id="cb13-13" data-line-number="13">  <span class="dt">C347 =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">1424</span>, <span class="dv">24</span>),</a>
<a class="sourceLine" id="cb13-14" data-line-number="14">  <span class="dt">GOU =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">1575</span>, <span class="dv">17</span>),</a>
<a class="sourceLine" id="cb13-15" data-line-number="15">  <span class="dt">LMP =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">642</span>, <span class="dv">18</span>),</a>
<a class="sourceLine" id="cb13-16" data-line-number="16">  <span class="dt">MAZ =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">1141</span>, <span class="dv">12</span>),</a>
<a class="sourceLine" id="cb13-17" data-line-number="17">  <span class="dt">PEP =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">2538</span>, <span class="dv">112</span>)</a>
<a class="sourceLine" id="cb13-18" data-line-number="18">)</a>
<a class="sourceLine" id="cb13-19" data-line-number="19"></a>
<a class="sourceLine" id="cb13-20" data-line-number="20"><span class="co"># Build the calibration curve</span></a>
<a class="sourceLine" id="cb13-21" data-line-number="21">calib_curve &lt;-<span class="st"> </span><span class="kw"><a href="../reference/fit.html">fit</a></span>(</a>
<a class="sourceLine" id="cb13-22" data-line-number="22">  calib_spc,</a>
<a class="sourceLine" id="cb13-23" data-line-number="23">  noise_spc,</a>
<a class="sourceLine" id="cb13-24" data-line-number="24">  <span class="dt">range =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">165</span>, <span class="dv">2800</span>), <span class="co"># Set the integration range (in keV)</span></a>
<a class="sourceLine" id="cb13-25" data-line-number="25">  <span class="dt">intercept =</span> <span class="ot">TRUE</span></a>
<a class="sourceLine" id="cb13-26" data-line-number="26">)</a>
<a class="sourceLine" id="cb13-27" data-line-number="27"></a>
<a class="sourceLine" id="cb13-28" data-line-number="28"><span class="co"># The linear model can be accessed for further investigations</span></a>
<a class="sourceLine" id="cb13-29" data-line-number="29"><span class="co"># summary(calib_curve[["model"]])</span></a>
<a class="sourceLine" id="cb13-30" data-line-number="30"></a>
<a class="sourceLine" id="cb13-31" data-line-number="31"><span class="co"># Plot the calibration curve</span></a>
<a class="sourceLine" id="cb13-32" data-line-number="32"><span class="kw"><a href="../reference/plot.html">plot</a></span>(calib_curve) <span class="op">+</span></a>
<a class="sourceLine" id="cb13-33" data-line-number="33"><span class="st">  </span>ggplot2<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggplot2/topics/ggtheme">theme_bw</a></span>()</a></code></pre></div>
<p><img src="gamma_files/figure-html/dose-rate-calib-1.png" width="480" style="display: block; margin: auto;"></p>
<p>New dose rate values can be predicted.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" data-line-number="1"><span class="co"># Import spectra</span></a>
<a class="sourceLine" id="cb14-2" data-line-number="2">test_dir &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/system.file">system.file</a></span>(<span class="st">"extdata/crp2a/test"</span>, <span class="dt">package =</span> <span class="st">"gamma"</span>)</a>
<a class="sourceLine" id="cb14-3" data-line-number="3">test_spc &lt;-<span class="st"> </span><span class="kw"><a href="../reference/read.html">read</a></span>(test_dir, <span class="dt">skip =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb14-4" data-line-number="4"></a>
<a class="sourceLine" id="cb14-5" data-line-number="5"><span class="co"># Estimate the gamma dose rate</span></a>
<a class="sourceLine" id="cb14-6" data-line-number="6">dose_rate &lt;-<span class="st"> </span><span class="kw"><a href="../reference/predict.html">predict</a></span>(calib_curve, test_spc, <span class="dt">simplify =</span> <span class="ot">TRUE</span>)</a></code></pre></div>
<table class="table">
<caption>Gamma dose rate estimates</caption>
<thead><tr class="header">
<th></th>
<th align="right">Dose</th>
<th align="right">Error</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>BR2011-08</td>
<td align="right">313.632</td>
<td align="right">11.137</td>
</tr>
<tr class="even">
<td>BR2011-15A</td>
<td align="right">195.302</td>
<td align="right">6.939</td>
</tr>
<tr class="odd">
<td>BR2011-15B</td>
<td align="right">193.735</td>
<td align="right">6.881</td>
</tr>
<tr class="even">
<td>BR2011-16</td>
<td align="right">141.665</td>
<td align="right">5.033</td>
</tr>
<tr class="odd">
<td>BR2011-20</td>
<td align="right">1358.085</td>
<td align="right">48.209</td>
</tr>
<tr class="even">
<td>BR2011-23</td>
<td align="right">393.568</td>
<td align="right">13.972</td>
</tr>
<tr class="odd">
<td>BR2011-24</td>
<td align="right">349.229</td>
<td align="right">12.400</td>
</tr>
<tr class="even">
<td>BR2011-26</td>
<td align="right">338.581</td>
<td align="right">12.021</td>
</tr>
<tr class="odd">
<td>BR2011-27</td>
<td align="right">272.910</td>
<td align="right">9.692</td>
</tr>
<tr class="even">
<td>BR2011-29</td>
<td align="right">235.469</td>
<td align="right">8.361</td>
</tr>
</tbody>
</table>
</div>
<div id="references" class="section level1 unnumbered">
<h1 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h1>
<div id="refs" class="references">
<div id="ref-morhac1997">
<p>Morháč, Miroslav, Ján Kliman, Vladislav Matoušek, Martin Veselský, and Ivan Turzo. 1997. “Background Elimination Methods for Multidimensional Coincidence <span class="math inline">\(\gamma\)</span>-Ray Spectra.” <em>Nuclear Instruments and Methods in Physics Research Section A: Accelerators, Spectrometers, Detectors and Associated Equipment</em> 401 (1): 113–32. <a href="https://doi.org/10.1016/S0168-9002(97)01023-1">https://doi.org/10.1016/S0168-9002(97)01023-1</a>.</p>
</div>
<div id="ref-morhac2008">
<p>Morháč, Miroslav, and Vladislav Matoušek. 2008. “Peak Clipping Algorithms for Background Estimation in Spectroscopic Data.” <em>Applied Spectroscopy</em> 62 (1): 91–106. <a href="https://doi.org/10.1366/000370208783412762">https://doi.org/10.1366/000370208783412762</a>.</p>
</div>
<div id="ref-ryan1988">
<p>Ryan, C.G., E. Clayton, W.L. Griffin, S.H. Sie, and D.R. Cousens. 1988. “SNIP, a Statistics-Sensitive Background Treatment for the Quantitative Analysis of PIXE Spectra in Geoscience Applications.” <em>Nuclear Instruments and Methods in Physics Research Section B: Beam Interactions with Materials and Atoms</em> 34 (3): 396–402. <a href="https://doi.org/10.1016/0168-583X(88)90063-8">https://doi.org/10.1016/0168-583X(88)90063-8</a>.</p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#overview">Overview</a></li>
      <li><a href="#import-file">Import file</a></li>
      <li><a href="#inspect-spectrum">Inspect spectrum</a></li>
      <li>
<a href="#calibrate-the-energy-scale">Calibrate the energy scale</a><ul class="nav nav-pills nav-stacked">
<li><a href="#peak-parameters-estimation">Peak parameters estimation</a></li>
      <li><a href="#energy-scale-calibration">Energy scale calibration</a></li>
      </ul>
</li>
      <li><a href="#estimate-the-gamma-dose-rate">Estimate the gamma dose rate</a></li>
      <li><a href="#references">References</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Nicolas Frerebeau, Brice Lebrun, Guillaume Guérin, Christelle Lahaye, <a href="https://www.u-bordeaux-montaigne.fr"><img src="http://gamma.archaeo.science/logo_ubm.jpg" height="48"></a>, <a href="https://lascarbx.labex.u-bordeaux.fr"><img src="http://gamma.archaeo.science/logo_lascarbx.jpg" height="64"></a>.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.3.0.</p>
</div>
      </footer>
</div>

  

  </body>
</html>
